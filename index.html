<!DOCTYPE html>
<html>

<head>
  <title>Проект "Комменты"</title>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <div class="container">
    <ul class="comments">

      <!-- рендерится из JS -->

    </ul>

    <div class="delete-form">
      <button class="delete-form-button">Удалить последний комментарий</button>
    </div>


    <div class="add-form">
      <input type="text" class="add-form-name" placeholder="Введите ваше имя" />
      <textarea type="textarea" class="add-form-text" placeholder="Введите ваш коментарий" rows="4"></textarea>
      <div class="add-form-row">
        <button class="add-form-button">Написать</button>
      </div>
    </div>
  </div>
</body>




<script>
  "use strict";


  const ulElement = document.querySelector('ul[class="comments"]');
  const buttonElement = document.querySelector('button[class="add-form-button"]');
  const nameElement = document.querySelector('input[class="add-form-name"]');
  const textElement = document.querySelector('textarea[class="add-form-text"]');




  // СТРУКТУРА ХРАНЕНИЯ ДАННЫХ - МАССИВ ОБЪЕКТОВ

  let comments = [
    // {
    //   nameAuthor: "Глеб Фокин",
    //   timeComment: "12.02.22 12:18",
    //   commentText: "Это будет первый комментарий на этой странице",
    //   likesCounter: 3,
    //   isLike: false,
    //   isEdit: false,
    // },
    // {
    //   nameAuthor: "Варвара Н.",
    //   timeComment: "13.02.22 19:22",
    //   commentText: "Мне нравится как оформлена эта страница! ❤",
    //   likesCounter: 75,
    //   isLike: true,
    //   isEdit: false,
    // },
  ];




  // FETCH GET - получение комментов с сервера

  fetch("https://wedev-api.sky.pro/api/v1/:sveta-plaksina/comments",      // FETCH GET - получение комментов с сервера
        {
          method: "GET",
        }).then((response) => {
          response.json().then((responseData) => {
            comments = responseData.comments;
            renderComments();
          });
        });



  // ЛАЙК КОММЕНТАРИЯ                  

  const initLikeComments = () => {       // объявление функции добавления/удаления лайка(нажатие на сердечко)
    const listLikeButtons = document.querySelectorAll('.like-button');

    for (let like of listLikeButtons) {
      like.addEventListener("click", (event) => {
        event.stopPropagation();
        let indexLike = like.dataset.index;
        if (comments[indexLike].isLiked) {
          comments[indexLike].likes -= 1;
          comments[indexLike].isLiked = false;
        } else {
          comments[indexLike].likes += 1;
          comments[indexLike].isLiked = true;
        }

        renderComments();

      })
    }
  };





  // РЕПЛАЙ НА КОММЕНТАРИЙ

  const initReplyComment = () => {         // объявление функции ответа на комментарий с цитированием автора и текста

    const listLiItems = document.querySelectorAll('.comment');

    for (let liItem of listLiItems) {
      liItem.addEventListener("click", () => {
        let indexLiItem = liItem.dataset.index;
        let replyComment = `QUOTE_BEGIN ${comments[indexLiItem].author.name}:\n${comments[indexLiItem].text} QUOTE_END \n`;
        textElement.value = replyComment;

        renderComments();

      })
    }
  }





  // РЕНДЕРИНГ СТРАНИЦЫ

  const renderComments = () => {         // объявление функции рендеринга

    const commentsHTML = comments.map((comment, ind) => {

      let currentTime = new Date(comment.date);
      let commentTime = `${currentTime.toLocaleDateString('ru-Ru', { day: "2-digit", month: "2-digit", year: "2-digit" })} ${currentTime.toLocaleTimeString('ru-Ru', { hour: "2-digit", minute: "2-digit" })}`;

      return `
        <li data-index="${ind}" class="comment">
            <div class="comment-header">
                <div>${comment.author.name}</div>
                <div>${commentTime}</div>
            </div>
            <div class="comment-body">
                <div class="comment-text">
                ${comment.text.replaceAll("QUOTE_BEGIN", "<div class='quote'>").replaceAll("QUOTE_END", "</div>")}
                </div>
            </div>
            <div class="comment-footer">
                <div class="likes">
                <span class="likes-counter">${comment.likes}</span>
                <button data-index="${ind}" class="like-button ${comment.isLiked ? "-active-like" : ""}"></button>
                </div>
            </div>
        </li> `;
    }).join("");
    ulElement.innerHTML = commentsHTML;

    initLikeComments();           // вызов функции добавления/удаления лайка(нажатие на сердечко)

    initReplyComment();           // вызов функции ответа на комментарий с цитированием автора и текста

  }






  // ПЕРЕКРАСКА КНОПКИ "НАПИСАТЬ" В ФОРМЕ ВВОДА КОММЕНТАРИЯ ПОСЛЕ НАЧАЛА ВВОДА В ПОЛЕ ИМЕНИ И ТЕКСТА

  buttonElement.className = 'error-add-form-button'; // сбрасываю стиль кнопки "Написать" на серый, чтобы было понятно,
  // что без заполнения полей Имя и Комментарий отправить форму нельзя

  let nameElementCheck = false;          // для проверки событий пользователь начинает печать и в поле Имя,
  let textElementCheck = false;          // и в поле Комментарий ввожу булевые переменные

  function handleInputs() {              // объявление функции, которая перекрашивает кнопку "Написать" в зеленый цвет
    if (nameElementCheck && textElementCheck) {      // ввод и в Имя и в текст произошел
      buttonElement.className = 'add-form-button';   // перекрашиваем кнопку
    }
  }

  nameElement.addEventListener("input", () => {   // вызов функции перекраски "Написать" в зеленый цвет
    nameElementCheck = true;
    handleInputs();
  });

  textElement.addEventListener("input", () => {   // вызов функции перекраски "Написать" в зеленый цвет
    textElementCheck = true;
    handleInputs();
  });






  // ДОБАВЛЕНИЕ НОВОГО КОММЕНТАРИЙ ЧЕРЕЗ ФОРМУ ВВОДА

  let buttonCheck = false;  // для проверки событий нажата либо кнопка "Написать",
  let enterCheck = false;   // либо кнопка "Enter" ввожу переменные, со значением по умолчанию

  function handleButtons() {          // объявление функции добавления комментария



    if (buttonCheck || enterCheck) {  // клик либо на кнопку "Написать", либо на "Enter" произошел
      if (nameElement.value === '' || textElement.value === '') { // если имя или текст незаполнены, но кнопка "Написать" или "Enter" нажата,
        buttonElement.className = 'error-add-form-button';        // то элемент не добавлять и кнопку "Написать" покрасить в серый цвет
        return;
      }


      // comments.push({                   // добавление коммента на страницу путем включения объекта в массив
      //   // nameAuthor: nameElement.value
      //   //   .replaceAll("&", "&amp;")
      //   //   .replaceAll("<", "&lt;")
      //   //   .replaceAll(">", "&gt;")
      //   //   .replaceAll('"', "&quot;"),
      //   timeComment: commentTime,
      //   // commentText: textElement.value
      //   //   .replaceAll("&", "&amp;")
      //   //   .replaceAll("<", "&lt;")
      //   //   .replaceAll(">", "&gt;")
      //   //   .replaceAll('"', "&quot;"),
      //   likesCounter: 0,
      //   isLike: false,
      //   isEdit: false,
      // });


      


      // FETCH POST - добавление коммента на страницу через отправку по API на сервер

      fetch("https://wedev-api.sky.pro/api/v1/:sveta-plaksina/comments",    // FETCH POST - отправляем коммент на сервер
        {
          method: "POST",
          body: JSON.stringify({
            name: nameElement.value
                  .replaceAll("&", "&amp;")
                  .replaceAll("<", "&lt;")
                  .replaceAll(">", "&gt;")
                  .replaceAll('"', "&quot;"),
            text: textElement.value
                  .replaceAll("&", "&amp;")
                  .replaceAll("<", "&lt;")
                  .replaceAll(">", "&gt;")
                  .replaceAll('"', "&quot;"),
            isLiked:	false,
            likes: 0,
          }),
        }).then((response) => {
          response.json().then((responseData) => {
            comments = responseData.comments;
          });
        });
      
        fetch("https://wedev-api.sky.pro/api/v1/:sveta-plaksina/comments",      // FETCH GET - получаем комменты с сервера и рендерим их
        {
          method: "GET",
        }).then((response) => {
          response.json().then((responseData) => {
            comments = responseData.comments;
            renderComments();
          });
        });


      nameElement.value = '';           // возвращаем начальные значения полям формы ввода
      textElement.value = '';
      buttonElement.className = 'error-add-form-button';
      nameElementCheck = false;
      textElementCheck = false;
    };
  };

  buttonElement.addEventListener("click", () => {   // вызов функции добавления комментария по клику на кнопку "Написать"
    buttonCheck = true;
    handleButtons();
  });

  document.addEventListener("keyup", (event) => {   // вызов функции добавления комментария по клику на кнопку "Enter"
    if (event.key === 'Enter') {
      enterCheck = true;
      handleButtons();
    }
  });





  // функционал удаления последнего комментария
  let buttonDelete = document.querySelector('button[class="delete-form-button"]');
  buttonDelete.addEventListener("click", () => {
    let lis = document.querySelectorAll('.comment');  // создаем коллекцию/псевдомассив из элементов с классом '.comment'
    let liDelete = lis[lis.length - 1];  // определяем элемент для удаления по индексу последнего в коллекции
    liDelete.parentNode.removeChild(liDelete); // вызываем метод удаления потомка коллекции - элемента для удаления
  });




</script>

</html>